# 文档数据库的存储与索引
上一节介绍了文档数据库的文档模型，本节以MongoDB为范例，介绍文档数据的组织方式以及索引的构建与使用。

## 文档数据存储

 数据库系统的数据组织方式决定着数据库存取操作的性能。文档数据库中的文档被组织在一个个数据块中并存储于硬盘，所有的文档数据块通过Inode结构被组织起来形成一个个文档集。当处理用户读取数据请求时，系统需要扫描文档集中的所有数据块，然后筛选出符合查询条件的文档。这种扫描整个文档集的查询效率是非常低的，尤其是在处理大数据集时，查询时间可能高达几分钟。

为了提升文档的查询效率，文档数据库系统通常采用B+树索引结构来重新组织数据。索引是对文档的某一属性值或多个属性值进行排序的存储结构，它能够在文档集中快速地搜索某个或多个文档属性值并根据文档属性值直接定位到文档所在的数据块。索引实现的是从文档属性值到文档所在数据块地址的映射，有了索引结构，系统在查询文档时就避免了整个文档集的全部扫描。

## 索引创建与使用

数据库系统对外提供了指令允许用户创建索引。文档数据库系统MongoDB的索引创建指令为createIndex，该指令包含两个参数，第一个参数指定要创建的属性字段和索引键值的排序类型，第二个参数为可选参数。

```bson
[例D2.1] 索引创建
db.student.createIndex({"sno":1})  // 单键索引
db.student.createIndex({"name":1, "age":-1})  //复合索引
```

createIndex可以在一个属性或者多个属性上创建索引。前者称为单键索引，后者称为复合索引。在例D2.1中，第一行表示在student文档集中的文档"sno"属性上创建索引，"sno"属性值（索引键值）按升序排列；第二行表示在文档的"name"和"age"两个属性上创建索引，"name"和"age"共同作为索引键值，索引键值首先按"name"升序排列，然后在每个"name"内按"age"降序排列。

```bson
[例D2.2] 索引使用
db.student.find({"sno":"120"})
db.student.find({"name":"Ben", "age":"21"})
```

用户显示执行createIndex指令之后，文档数据库系统以索引属性为键值构建B+树索引结构。当用户使用索引属性进行文档查询时，MongoDB可以通过对应索引的B+树快速地定位查询文档所在的数据块地址并读取文档内容。例D2.2中，两个查询分别使用例D2.1中的单键索引和复合索引查询文档。值得额外注意的是，如果想要使用复合索引实现文档的快速查询，那么查询指令中的查询条件需要满足索引的**最左前缀原则**，即查询条件中必须包含索引的第一个属性。也就是说，想要使用基于"name"和"age"构建的复合索引，查询条件中必须包含"name"属性。

除了显示创建索引之外，MongoDB默认会为每个文档集创建一个索引。当用户新建文档集，插入文档时，MongoDB自动地在文档的"\_id"属性上创建索引。以"\_id"属性作为键值构建的B+树结构替代Inode结构，实现文档和文档集的组织与管理。在MongoDB中，"\_id"称为文档的主键，基于主键构建的索引称为主键索引。在主键索引结构中，叶子节点的键值唯一地指向一个数据块地址。基于非主键构建的索引称为辅助索引或者二级索引，该索引结构中叶子节点的键值可能指向多个数据块地址。

除了提到的单键索引、复合索引、主键索引和二级索引，MongoDB还支持唯一索引、文本索引、地理空间索引、聚簇索引和非聚簇索引等。这里就不做更多详细地讲解。

## 索引使用规则

索引可以提高数据查询的效率，那么，索引是不是越多越好呢? 是否需要在每一个属性上都创建索引呢？答案当然是否定的。其原因有以下两点:

* 耗费存储空间。每创建一个索引需要占用存储空间来存储B+树结构，B+树的每一个节点对应存储空间中的一个数据块。有时一个索引所用的存储空间与一个文档集中所有文档所用的存储空间几乎相同。索引越多，耗费的存储空间也就越大。
* 增加数据更新操作的代价。当对文档数据进行增删改操作时，索引结构也要做相应地改变。比如，删除某个文档时，需要同时将该文档在索引结构中的索引键值进行删除。否则，之后通过索引进行查询时就会出错。如果文档集拥有很多索引，那么就会增加对文档集的更新代价，从而导致系统性能降低。

因此，在开发应用软件过程中是否需要创建索引由开发人员进行抉择，在查询效率、存储空间和更新代价之间进行取舍。

那么，我们到底应该在哪些属性上创建索引呢？总的来说，适合创建索引的属性需要具备以下特点:

* 常用，即经常被用作查询条件的属性。比如，我们经常用人的姓名来查询文档，那么就有必要在名字上创建索引，这样就能够通过索引提高查询效率。
* 稳定，即不会经常被修改的属性。一旦属性被修改，那么基于该属性创建的索引结构也会被修改。B+树节点的修改通常需要先删除节点，然后再插入新节点，因此一次索引更新的代价是巨大的。我们知道个人的银行账户号是不变的，因此可以在账户号上创建索引，而账户余额是经常变化的属性，因此不适合用于创建索引。
* 区分度高，即文档集中拥有相同属性值的文档数量很少。比如，文档"\_id"属性，它的区分度就很高，通过某一“\_id”值能够唯一地确定某一文档；再比如人的姓名，其区分度相对较高。在学校、班级、公司等范围内，重名的人相对比较少。因此，"\_id"属性和姓名都适合用于创建索引。在它们的索引结构中，叶子节点的键值要么指向一个数据块要么只指向几个数据块。但是，人的性别只有男和女两种取值，其区分度很低，不适合用于创建索引。

以上简单地介绍了MongoDB文档数据库的数据组织方式、索引的创建以及索引的使用原则。其他文档数据库系统的索引创建与使用，读者需要阅读对应系统的相关文档。

[**上一页<<**](chapterD1.2.md) | [**>>下一页**](chapterD3.1.md)



