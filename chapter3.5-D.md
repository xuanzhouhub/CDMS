# 文档数据库查询处理
本节将以MongoDB为例，介绍文档数据库的计算方法。文档数据库系统除了提供简单的数据存取功能，还能提供一定的计算能力， 支持复杂的聚合操作。

## 聚合查询的计算

在文档数据库中，聚合查询允许将多个文档组合在一起，然后对组合后的结果进行一系列的操作（例如，分组、求和、平均、计数、最大、最小等），从而实现对数据的分析和洞察。

MongoDB使用聚合管道（Aggregation Pipeline）的方式来处理文档的聚合查询。聚合管道是一种批处理模式的计算框架，它由一个或者多个数据处理阶段组成。聚合管道具有以下特点：

* 每个阶段对输入的文档执行某种操作，如筛选、分组、聚合计算；
* 所有阶段依次执行，每个阶段的计算结果（文档）作为下一阶段的输入，直到执行完最后一个阶段；
* 聚合管道能够处理文档的分组，并返回分组结果，如分组中的平均值、最大值、最小组、总和。

在MongoDB中，我们使用如下命令来构建和使用聚合管道：

```sql
db.mycollection.aggregate( [ 
							  {stage},  /*处理阶段*/
							  {stage},  /*处理阶段*/
							  ...  
						  ] )
```

常用的管道聚合阶段包括：

| MongoDB管道聚合阶段 |          描述          |  SQL等价运算符  |
| ------------------- | :--------------------: | :-------------: |
| $match              |   筛选满足条件的文档   |      where      |
| $project            | 增加、删除、重命名属性 |     select      |
| $group              |     对文档进行分组     |    group by     |
| $sort               |          排序          |    order by     |
| $limit              |     限制结果的数量     |      limit      |
| $lookup             |        左外连接        | left outer join |

## 聚合查询举例

接下来，我们以学生-课程数据库为例来介绍文档数据库的聚合查询。学生-课程数据库中包含学生文档集（student）以及学生选课文档集（sc），各文档集中的数据实例如下：

```SQL
学生文档集(student)中包含如下4个文档，每个文档包含学号、姓名、性别、年龄、系五个属性
{"sno": "2022001","sname": "沐辰","gender": "male","age": 19,"department": "计算机"}
{"sno": "2022123","sname": "浩宇","gender": "male","age": 18 ,"department": "计算机"}
{"sno": "2022191","sname": "若汐","gender": "female","age": 18 ,"department": "数学"}
{"sno": "2022267","sname": "依诺","gender": "female","age": 19 ,"department": "金融"}

学生选课文档集(sc)中包含如下4个文档，每个文档包含学号、课程号、课程名、成绩四个属性
{"sno": "2022001","cno": "1","cname": "高数","grade": 92}
{"sno": "2022001","cno": "3","cname": "数据库","grade": 85}
{"sno": "2022191","cno": "2","cname": "C语言","grade": 88}
{"sno": "2022191","cno": "3","cname": "数据库","grade": 90}
```

```SQL
[例3.6] 查询每个系中女生的人数并按降序排序
db.student.aggregate( [ 
						{
						    $match:{"gender":"female"}
						},  /*$match阶段*/
						{
						    $group:{
						        "_id":"department",   /*按department属性进行分组*/
						        "totalnum":{"$count":{}} /*统计每个分组中的文档数量*/
						     }
						},  /*$group阶段*/
    					{
    						$sort:{"totalnum":-1}  /*按totalnum的降序排序*/
    					}   /*sort阶段*/
					] )
```

例3.6的聚合查询包含\$match、\$group和\$sort三个阶段，首先\$match阶段从student文档集中筛选出gender属性为"female"的学生文档，然后\$group阶段对筛选结果按department属性进行分组，并统计每个分组的个数，最后\$sort阶段按照每个分组统计的个数降序排序。聚合查询的结果如下：

```SQL
{"_id": "计算机","totalnum":2},
{"_id": "数学","totalnum":1},
{"_id": "金融","totalnum":1}
```

注意：\$group阶段中的“\_id”字段是必填，用于指定分组属性，如果“\_id”值为null则表示对输入文档不进行分组，整个输入文档为一个组。\$group阶段中的其他字段则是对分组之后的结果进行聚合操作，比如求每个分组的平均值“\$avg”，返回每个分组的数值总和“$sum”，返回每个分组的最大值\$max等。\$sort阶段是对指定的字段进行排序，-1表示升序排序，1表示降序排序。

```SQL
[例3.7] 查询前3个学生的选课课程的情况
db.student.aggregate( [ 
						{
						    $lookup:{
    							"from":"sc", /*student文档集与sc文档集进行左外连接*/
    							"localFiled":"sno", /*指定student中的sno属性与sc进行等值连接*/
    							"foreignField":"sno", /*指定sc中的sno属性与student进行等值连接*/
    							"as"："courses"  /*指定连接结果的属性名称*/
   							 }
						},  /*$lookup阶段*/
						{
						    $project:{
    							"sno":1,
						        "sname":1,  
						        "courses":1
						     }
						},  /*$project阶段*/
    					{
    						$limit:3   /*返回查询结果的前3个文档*/
    					}   /*$limit阶段*/
					] )
```

例3.7的聚合查询包含\$lookup、\$project和\$limit三个阶段，首先\$lookup阶段使用student文档集的sno属性与sc文档集的sno属性进行左外连接将两个文档集的文档连接在一起，然后\$project阶段指定显示连接结果中的学生学号、学生姓名以及学生选课课程三个属性，最后\$limit阶段返回查询结果的前3个。聚合查询的结果如下：

```SQL
{
	"sno": "2022001",
	"sname": "沐辰",
	"courses": [
        {"sno": "2022001","cno": "1","cname": "高数","grade": 92},
        {"sno": "2022001","cno": "3","cname": "数据库","grade": 85}
    ]
}

{
	"sno": "2022123",
	"sname": "浩宇",
	"courses": [{}]
}

{
	"sno": "2022191",
	"sname": "若汐",
	"courses": [
        {"sno": "2022191","cno": "2","cname": "C语言","grade": 88},
		{"sno": "2022191","cno": "3","cname": "数据库","grade": 90}
    ]
}
```


通常，为了进一步提高聚合查询的效率，构建聚合管道时会将\$match阶段放在管道的前面位置，这既可以快速过滤不需要的文档，减少管道中的数据量，还可以在查询时使用索引来提高性能。

以上简单地介绍了MongoDB文档数据库的聚合查询及其计算方式聚合管道。更加详细的内容，读者需要阅读对应系统的相关文档。

[**上一页<<**](chapter3.4.md) | [**>>下一页**](chapter4.1.md)



